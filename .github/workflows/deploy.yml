name: Deploy Website

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'site/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  DEPLOY_PATH: /home/ubuntu/secure-static-site-nginx

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
          
      - name: Test SSH Connection
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "echo 'SSH connection successful'"
      
      - name: Sync deployment scripts to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          # Create deployment directory if it doesn't exist
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST "mkdir -p $DEPLOY_PATH"
          
          # Sync deployment scripts
          rsync -avz \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            deploy-site.sh setup-server.sh update_dns.sh full_deploy.sh .env.example \
            $SSH_USER@$SSH_HOST:$DEPLOY_PATH/
          
          # Make scripts executable on server
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST "cd $DEPLOY_PATH && chmod +x *.sh && ls -la *.sh"
          
          echo "âœ… Deployment scripts synced to server"
      
      - name: Deploy website files
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          # Create deployment directory if it doesn't exist
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST "mkdir -p $DEPLOY_PATH"
          
          # Sync website files to server
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./site/ \
            $SSH_USER@$SSH_HOST:$DEPLOY_PATH/site/
          
          echo "âœ… Website files synced to server"
      
      - name: Create or update environment file
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DUCKDNS_DOMAIN: ${{ secrets.DUCKDNS_DOMAIN }}
          DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}
          LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}
        run: |
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST "bash -s" << 'ENDSSH'
          set -e
          DEPLOY_PATH=/home/ubuntu/secure-static-site-nginx
          
          if [ ! -f $DEPLOY_PATH/.env ]; then
            cat > $DEPLOY_PATH/.env << 'ENVEOF'
          DUCKDNS_DOMAIN="${{ secrets.DUCKDNS_DOMAIN }}"
          DUCKDNS_TOKEN="${{ secrets.DUCKDNS_TOKEN }}"
          LETSENCRYPT_EMAIL="${{ secrets.LETSENCRYPT_EMAIL }}"
          SITE_SOURCE_DIR="$DEPLOY_PATH/site"
          ENVEOF
            chmod 600 $DEPLOY_PATH/.env
            echo "âœ… Environment file created"
          else
            echo "â„¹ï¸  Environment file already exists"
          fi
          ENDSSH
      
      - name: Run deployment script
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST "bash -s" << 'ENDSSH'
          set -e
          DEPLOY_PATH=/home/ubuntu/secure-static-site-nginx
          cd $DEPLOY_PATH
          
          if [ ! -f deploy-site.sh ]; then
            echo "âŒ deploy-site.sh not found!"
            echo "Current directory: $(pwd)"
            echo "Files present:"
            ls -la
            exit 1
          fi
          
          ./deploy-site.sh
          echo "âœ… Deployment completed successfully"
          ENDSSH
      
      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          # Wait a moment for Nginx to reload
          sleep 3
          
          # Test HTTP response
          if [ -n "$DOMAIN" ]; then
            echo "Testing https://$DOMAIN"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN" || echo "000")
          else
            echo "Testing http://$SSH_HOST"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$SSH_HOST" || echo "000")
          fi
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Website is responding with HTTP 200"
          else
            echo "âš ï¸ Website returned HTTP $HTTP_CODE"
            exit 1
          fi
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ Deployment Successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Website files synced"
          echo "âœ… Deployment script executed"
          echo "âœ… Website is live and responding"
          echo ""
          if [ -n "${{ secrets.DOMAIN }}" ]; then
            echo "ðŸŒ Visit: https://${{ secrets.DOMAIN }}"
          else
            echo "ðŸŒ Visit: http://${{ secrets.SSH_HOST }}"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment Failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Please check the logs above for details"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
